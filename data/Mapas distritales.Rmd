```{r}
library(readxl)
library(tidyverse)
```

## Regiones

## 2014

###Carga data: 

```{r}
dataGR14=read_xlsx("Tabla10-ERM2014-Regional.xlsx")
```

###Ordenar data:

Ubigeos:

```{r}
#Ubigeo región: 
dataGR14$TXUBIGEOREGION=dataGR14$TXUBIGEO
substr(dataGR14$TXUBIGEOREGION,3,6)='0000'
```

Electores por distritos:

```{r}
electores = dataGR14 %>% 
            group_by(TXUBIGEO) %>% #seleccionar una fila por distrito
           summarise(electoresGR14 = max(ELECTORES, na.rm = T)) 

electores$TXUBIGEOREGION=electores$TXUBIGEO
substr(electores$TXUBIGEOREGION,3,6)='0000'

data_finalGR14 = electores %>% 
            group_by(TXUBIGEOREGION) %>% #seleccionar una fila por distrito
           summarise(electoresGR14 = sum(electoresGR14, na.rm = T)) 
```

Votos emitidos por distritos:

```{r}
emitidos = dataGR14 %>% group_by(TXUBIGEOREGION) %>% 
           summarise(emitidosGR14 = sum(VOTOS, na.rm = T))

data_finalGR14 = left_join(data_finalGR14, emitidos, by="TXUBIGEOREGION") #join
```

Calcular ausentes: 

```{r}
data_finalGR14 = data_finalGR14 %>% 
  mutate(ausentesGR14= electoresGR14 - emitidosGR14, 
         por_ausentesGR14 = (ausentesGR14/electoresGR14)*100)
```

Votos blancos + nulos

```{r}
blancos_nulos = dataGR14 %>% filter(TIPOORGPOL == "VOTOS EN BLANCO" | TIPOORGPOL =="VOTOS NULOS" ) %>%
                group_by(TXUBIGEOREGION) %>% 
                summarise(blancosnulosGR14 = sum(VOTOS, na.rm = T)) 

data_finalGR14 = left_join(data_finalGR14, blancos_nulos, by="TXUBIGEOREGION") #join

data_finalGR14  = data_finalGR14 %>% 
          mutate (por_blancosnulosGR14 = (blancosnulosGR14/emitidosGR14)*100) 
```

votos validos:

```{r}
data_finalGR14  = data_finalGR14 %>% 
          mutate (validosGR14 = emitidosGR14-blancosnulosGR14) 
```

votos partidos politicos:

```{r}
partidos_politicos = dataGR14 %>% filter(TIPOORGPOL == "PARTIDO POLITICO") %>%
                group_by(TXUBIGEOREGION) %>% 
                summarise(partidosGR14 = sum(VOTOS, na.rm = T)) 

data_finalGR14 = left_join(data_finalGR14, partidos_politicos, by="TXUBIGEOREGION") #join
```

votos movimientos regionales:

```{r}
mov_regionales = dataGR14 %>% filter(TIPOORGPOL == "MOVIMIENTO REGIONAL") %>%
                group_by(TXUBIGEOREGION) %>% 
                summarise(movimientosGR14 = sum(VOTOS, na.rm = T)) 

data_finalGR14 = left_join(data_finalGR14, mov_regionales, by="TXUBIGEOREGION") #join
```

porcentaje partidos/movimientos

```{r}  
data_finalGR14  = data_finalGR14 %>% 
          mutate (por_partidosGR14 = (partidosGR14/validosGR14)*100,
                  por_movimientosGR14 = (movimientosGR14/validosGR14)*100)
```

##Ganadores GR

Eliminar votos blancos y nulos:

```{r}
dataGR14= dataGR14[!dataGR14$TIPOORGPOL == "VOTOS EN BLANCO",]
dataGR14= dataGR14[!dataGR14$TIPOORGPOL == "VOTOS NULOS",]
```

Ordenar tabla según votos

```{r}
dataGR14 <- dataGR14[order(dataGR14$TXUBIGEO, -dataGR14$VOTOS),] 
```

###Ganadores:

```{r}
ganadoresGR =dataGR14 %>% group_by(TXUBIGEOREGION,TXORGPOL) %>% summarise(votos = sum(VOTOS, na.rm = T))  %>% mutate(ganadorGR14 = TXORGPOL)
validosGR =dataGR14 %>% group_by(TXUBIGEOREGION) %>% summarise(votos_validos = sum(VOTOS, na.rm = T)) 
ganadoresGR14 = left_join(ganadoresGR, validosGR, by="TXUBIGEOREGION") #join
ganadoresGR14 = ganadoresGR14  %>% mutate(por_voto = (votos/votos_validos)*100)
ganadoresGR14 = ganadoresGR14[order(ganadoresGR14$TXUBIGEOREGION, -ganadoresGR14$por_voto),] 
ganadoresGR14 = ganadoresGR14 %>% filter(row_number()==1) %>% select(TXUBIGEOREGION,ganadorGR14)
ganadoresGR14 = ganadoresGR14[complete.cases(ganadoresGR14),]
```

Hay algunos que tuvieron que ir a segunda vuelta y ganaron otras organizaciones:

```{r}
ganadoresGR14[2,2] = "MOVIMIENTO INDEPENDIENTE REGIONAL PURO ANCASH"#ANCASH
ganadoresGR14[3,2] = "MOVIMIENTO INDEPENDIENTE FUERZA CAMPESINA REGIONAL" #APURIMAC
ganadoresGR14[4,2] = "AREQUIPA, TRADICION Y FUTURO" #AREQUIPA
ganadoresGR14[7,2] = "KAUSACHUN CUSCO" #CUSCO
ganadoresGR14[21,2] = "FUERZA POPULAR" #SAN MARTIN
```

```{r}
data_finalGR14 = left_join(data_finalGR14, ganadoresGR14, by="TXUBIGEOREGION") #join 
head(data_finalGR14)
```

###Indicadores políticos 

###### Concentración:

- P1: Proporción de votos válidos obtenidos por el partido más votado.
- P2: Proporción de votos válidos obtenidos por el segundo par- tido más votado.

C= P1 + P2

```{r}
ganadoresGR =dataGR14 %>% group_by(TXUBIGEOREGION,TXORGPOL) %>% summarise(votos = sum(VOTOS, na.rm = T))  %>% mutate(ganadorGR14 = TXORGPOL)
```

```{r}
ganadoresGR = ganadoresGR [order(ganadoresGR$TXUBIGEOREGION, -ganadoresGR$votos),] 
```


Votos ganador
```{r}
primero = ganadoresGR %>% group_by(TXUBIGEOREGION) %>% filter(row_number()==1) %>% mutate(primeroGR14=votos)

data_finalGR14 = left_join(data_finalGR14, primero[c(1,5)], by="TXUBIGEOREGION") #join 
```

Votos segundo
```{r}
segundo = ganadoresGR %>% group_by(TXUBIGEOREGION) %>% filter(row_number()==2) %>% mutate(segundoGR14=votos)

data_finalGR14 = left_join(data_finalGR14, segundo[c(1,5)], by="TXUBIGEOREGION") #join 
```

Calculo concentración:

```{r}
data_finalGR14 = data_finalGR14 %>% mutate(concentracionGR14 = primeroGR14/validosGR14 + segundoGR14/validosGR14)

data_finalGR14=data_finalGR14[-c(14,15)]
```

###### NEP Y Herfindahl

Nep:

- P= Proporción de votos válidos obtenidos por las organizacio- nes políticas en cada circunscripción.
                          
NEP = 1/ SUM(p^2)     

Herfindahl: SUM(p^2)   

Añadir votos validos a la tabla general:

```{r}
ganadoresGR = left_join(ganadoresGR, data_finalGR14[c(1,8)], by="TXUBIGEOREGION") #join 
```

Calcular proporción de votos validos 

```{r}
ganadoresGR$prop_votos2 = (ganadoresGR$votos/ganadoresGR$validosGR14)^2
```

NEP y Herfindahl por distrito:

```{r}
NEP = ganadoresGR %>% group_by(TXUBIGEOREGION) %>% 
  summarise(HerfindahlGR14 = sum(prop_votos2, na.rm = T),
            NEPGR14 = 1/sum(prop_votos2, na.rm = T))

data_finalGR14 = left_join(data_finalGR14, NEP, by="TXUBIGEOREGION") #join 
```

listas:

Eliminar partidos que no tuvieron votos: 

```{r}
ganadoresGR=ganadoresGR[!ganadoresGR$votos==0,]
```

```{r}
listasGR14=ganadoresGR %>% group_by(TXUBIGEOREGION) %>%  summarise(listasGR14=n())

data_finalGR14 = left_join(data_finalGR14, listasGR14, by="TXUBIGEOREGION") #join 
```

```{r}
head(data_finalGR14)
```

##### GOBIERNO REGIONAL 2010

Carga data: 

```{r}
dataGR10=read_xlsx("Tabla9-ERM2010-Regional.xlsx")
head(dataGR10)
```

###Ubigeos

```{r}
#Ubigeo región: 
dataGR10$UBIGEOREGION=dataGR10$UBIGEO
substr(dataGR10$UBIGEOREGION,3,6)='0000'
```

Electores por distritos:

```{r}
electores = dataGR10 %>% 
            group_by(UBIGEO) %>% #seleccionar una fila por distrito
           summarise(electoresGR10 = max(NUMELECTORES, na.rm = T),
                     emitidosGR10 = max(NUM_VOTOS_EMITIDOS, na.rm=T))

electores$UBIGEOREGION=electores$UBIGEO
substr(electores$UBIGEOREGION,3,6)='0000'

data_finalGR10 = electores %>% 
            group_by(UBIGEOREGION) %>% #seleccionar una fila por distrito
           summarise(electoresGR10 = sum(electoresGR10, na.rm = T),
                     emitidosGR10 = sum(emitidosGR10,na.rm=T))
```


Calcular ausentes: 

```{r}
data_finalGR10 = data_finalGR10 %>% 
  mutate(ausentesGR10= electoresGR10 - emitidosGR10, 
         por_ausentesGR10 = (ausentesGR10/electoresGR10)*100)
```

votos validos:

```{r}
validos = dataGR10 %>% 
            group_by(UBIGEOREGION) %>% #seleccionar una fila por distrito
           summarise(validosGR10 = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 

data_finalGR10 = left_join(data_finalGR10, validos, by="UBIGEOREGION") #join

#Ojo, tengo casos con 0 votos validos.. estoy asumiento que esos son blancos y nulos
```

Votos blancos + nulos

```{r}
data_finalGR10 = data_finalGR10 %>% 
  mutate(blancosnulosGR10 = emitidosGR10 - validosGR10, 
         por_blancosnulosGR10 = (blancosnulosGR10/emitidosGR10)*100)
```

votos partidos politicos:

```{r}
partidos_politicos = dataGR10 %>% filter(TIPOORGPOL == "PARTIDO POLITICO") %>%
                group_by(UBIGEOREGION) %>% 
                summarise(partidosGR10 = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 

data_finalGR10 = left_join(data_finalGR10, partidos_politicos, by="UBIGEOREGION") #join
```

votos movimientos regionales:

```{r}
mov_regionales = dataGR10 %>% filter(TIPOORGPOL == "MOVIMIENTO REGIONAL") %>%
                group_by(UBIGEOREGION) %>% 
                summarise(movimientosGR10 = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 

data_finalGR10 = left_join(data_finalGR10, mov_regionales, by="UBIGEOREGION") #join

data_finalGR10$movimientosGR10[is.na(data_finalGR10$movimientosGR10)] = 0
```

porcentaje partidos/movimientos

```{r}
data_finalGR10  = data_finalGR10 %>% 
          mutate (por_partidosGR10 = (partidosGR10/validosGR10)*100,
                  por_movimientosGR10 = (movimientosGR10/validosGR10)*100) 
```

###Ganadores GR

Ordenar tabla en según votos

```{r}
dataGR10<- dataGR10[order(dataGR10$UBIGEO, -dataGR10$NUM_VOTOS_ORGPOL),] 
```

```{r}
ganadoresGR =dataGR10 %>% group_by(UBIGEOREGION,NOM_ORGPOLITICA) %>% summarise(votos = sum(NUM_VOTOS_ORGPOL, na.rm = T))  %>% mutate(ganadorGR10 = NOM_ORGPOLITICA)
validosGR =dataGR10 %>% group_by(UBIGEOREGION) %>% summarise(votos_validos = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 
ganadoresGR10 = left_join(ganadoresGR, validosGR, by="UBIGEOREGION") #join
ganadoresGR10 = ganadoresGR10  %>% mutate(por_voto = (votos/votos_validos)*100)
ganadoresGR10 = ganadoresGR10[order(ganadoresGR10$UBIGEOREGION, -ganadoresGR10$por_voto),] 
ganadoresGR10 = ganadoresGR10 %>% filter(row_number()==1) %>% select(UBIGEOREGION,ganadorGR10)
ganadoresGR10 = ganadoresGR10[complete.cases(ganadoresGR10),]
```

Hay algunos que tuvieron que ir a segunda vuelta y ganaron otras organizaciones:

```{r}
ganadoresGR10[5,2] = "ALIANZA PARA EL PROGRESO"#AYACUCHO
ganadoresGR10[14,2] = "PATRIA JOVEN" #LIMA
ganadoresGR10[18,2] = "ALIANZA REGIONAL TODOS POR PASCO" #PASCO
ganadoresGR10[20,2] = "PROYECTO POLITICO AQUI" #PUNO
ganadoresGR10[23,2] = "LUCHEMOS POR TUMBES" #TUMBES
```

```{r}
data_finalGR10 = left_join(data_finalGR10, ganadoresGR10, by="UBIGEOREGION") #join 
```

###Indicadores políticos 

###### Concentración:

```{r}
ganadoresGR =dataGR10 %>% group_by(UBIGEOREGION,NOM_ORGPOLITICA) %>% summarise(votos = sum(NUM_VOTOS_ORGPOL, na.rm = T))  %>% mutate(ganadorGR10 = NOM_ORGPOLITICA)
```

```{r}
ganadoresGR = ganadoresGR [order(ganadoresGR$UBIGEOREGION, -ganadoresGR$votos),] 
```

Votos ganador
```{r}
primero = ganadoresGR %>% group_by(UBIGEOREGION) %>% filter(row_number()==1) %>% mutate(primeroGR10=votos)

data_finalGR10 = left_join(data_finalGR10, primero[c(1,5)], by="UBIGEOREGION") #join 
```

Votos segundo
```{r}
segundo = ganadoresGR %>% group_by(UBIGEOREGION) %>% filter(row_number()==2) %>% mutate(segundoGR10=votos)

data_finalGR10 = left_join(data_finalGR10, segundo[c(1,5)], by="UBIGEOREGION") #join 
```

Calculo concentración:

```{r}
data_finalGR10 = data_finalGR10 %>% mutate(concentracionGR10 = primeroGR10/validosGR10 + segundoGR10/validosGR10)

data_finalGR10=data_finalGR10[-c(14,15)]
```

###### NEP Y Herfindahl

Añadir votos validos a la tabla general:

```{r}
ganadoresGR = left_join(ganadoresGR, data_finalGR10[c(1,6)], by="UBIGEOREGION") #join 
```

Calcular proporción de votos validos al cuadrado

```{r}
ganadoresGR$prop_votos2 = (ganadoresGR$votos/ganadoresGR$validosGR10)^2
```

NEP y Herfindahl por distrito:

```{r}
NEP = ganadoresGR %>% group_by(UBIGEOREGION) %>% 
  summarise(HerfindahlGR10 = sum(prop_votos2, na.rm = T),
            NEPGR10 = 1/sum(prop_votos2, na.rm = T))

data_finalGR10 = left_join(data_finalGR10, NEP, by="UBIGEOREGION") #join 
```

listas:

Eliminar partidos que no tuvieron votos: 

```{r}
ganadoresGR=ganadoresGR[!ganadoresGR$votos==0,]
```

```{r}
listasGR10=ganadoresGR %>% group_by(UBIGEOREGION) %>%  summarise(listasGR10=n())

data_finalGR10 = left_join(data_finalGR10, listasGR10, by="UBIGEOREGION") #join 
```

```{r}
head(data_finalGR10)
```

##### GOBIERNO REGIONAL 2006

Carga data: 

```{r}
dataGR06=read_xlsx("Tabla8-ERM2006-Regional.xlsx")
head(dataGR06)
```

### Ordenar data

Ubigeos

```{r}
#Ubigeo región: 
dataGR06$UBIGEOREGION=dataGR06$UBIGEO
substr(dataGR06$UBIGEOREGION,3,6)='0000'
```

Electores y emitidos:

```{r}
electores = dataGR06 %>% 
            group_by(UBIGEO) %>% #seleccionar una fila por distrito
           summarise(electoresGR06 = max(NUMELECTORES, na.rm = T),
                     emitidosGR06 = max(NUM_VOTOS_EMITIDOS, na.rm=T))

electores$UBIGEOREGION=electores$UBIGEO
substr(electores$UBIGEOREGION,3,6)='0000'

data_finalGR06 = electores %>% 
            group_by(UBIGEOREGION) %>% #seleccionar una fila por distrito
           summarise(electoresGR06 = sum(electoresGR06, na.rm = T),
                     emitidosGR06 = sum(emitidosGR06,na.rm=T))
```


Calcular ausentes: 

```{r}
data_finalGR06 = data_finalGR06 %>% 
  mutate(ausentesGR06= electoresGR06 - emitidosGR06, 
         por_ausentesGR06 = (ausentesGR06/electoresGR06)*100)
```

votos validos:

```{r}
validos = dataGR06 %>% 
            group_by(UBIGEOREGION) %>% #seleccionar una fila por distrito
           summarise(validosGR06= sum(NUM_VOTOS_ORGPOL, na.rm = T)) 

data_finalGR06 = left_join(data_finalGR06, validos, by="UBIGEOREGION") #join

#Ojo, tengo casos con 0 votos validos.. estoy asumiento que esos son blancos y nulos
```

Votos blancos + nulos

```{r}
data_finalGR06 = data_finalGR06 %>% 
  mutate(blancosnulosGR06 = emitidosGR06 - validosGR06, 
         por_blancosnulosGR06 = (blancosnulosGR06/emitidosGR06)*100)
```

votos partidos politicos:

```{r}
partidos_politicos = dataGR06 %>% filter(TIPOORGPOL == "PARTIDO POLITICO") %>%
                group_by(UBIGEOREGION) %>% 
                summarise(partidosGR06 = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 

data_finalGR06 = left_join(data_finalGR06, partidos_politicos, by="UBIGEOREGION") #join
```

votos movimientos regionales:

```{r}
mov_regionales = dataGR06 %>% filter(TIPOORGPOL == "MOVIMIENTO REGIONAL") %>%
                group_by(UBIGEOREGION) %>% 
                summarise(movimientosGR06 = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 

data_finalGR06 = left_join(data_finalGR06, mov_regionales, by="UBIGEOREGION") #join

data_finalGR06$movimientosGR06[is.na(data_finalGR06$movimientosGR06)] = 0
```

porcentaje partidos/movimientos

```{r}
data_finalGR06  = data_finalGR06 %>% 
          mutate (por_partidosGR06 = (partidosGR06/validosGR06)*100,
                  por_movimientosGR06 = (movimientosGR06/validosGR06)*100) 
```

###Ganadores GR

Eliminar:

```{r}
dataGR06= dataGR06[!dataGR06$TIPOORGPOL == "VOTOS EN BLANCO",]
dataGR06= dataGR06[!dataGR06$TIPOORGPOL == "VOTOS NULOS",]
```

Ordenar tabla en según votos

```{r}
dataGR06<- dataGR06[order(dataGR06$UBIGEO, -dataGR06$NUM_VOTOS_ORGPOL),] 
```

```{r}
ganadoresGR =dataGR06 %>% group_by(UBIGEOREGION,NOM_ORGPOLITICA) %>% summarise(votos = sum(NUM_VOTOS_ORGPOL, na.rm = T))  %>% mutate(ganadorGR06 = NOM_ORGPOLITICA)
validosGR =dataGR06 %>% group_by(UBIGEOREGION) %>% summarise(votos_validos = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 
ganadoresGR06 = left_join(ganadoresGR, validosGR, by="UBIGEOREGION") #join
ganadoresGR06 = ganadoresGR06  %>% mutate(por_voto = (votos/votos_validos)*100)
ganadoresGR06 = ganadoresGR06[order(ganadoresGR06$UBIGEOREGION, -ganadoresGR06$por_voto),] 
ganadoresGR06 = ganadoresGR06 %>% filter(row_number()==1) %>% select(UBIGEOREGION,ganadorGR06)
ganadoresGR06 = ganadoresGR06[complete.cases(ganadoresGR06),]
```


```{r}
data_finalGR06 = left_join(data_finalGR06, ganadoresGR06, by="UBIGEOREGION") #join 
```

###Indicadores políticos 

###### Concentración:

```{r}
ganadoresGR =dataGR06 %>% group_by(UBIGEOREGION,NOM_ORGPOLITICA) %>% summarise(votos = sum(NUM_VOTOS_ORGPOL, na.rm = T))  %>% mutate(ganadorGR06 = NOM_ORGPOLITICA)
```

```{r}
ganadoresGR = ganadoresGR [order(ganadoresGR$UBIGEOREGION, -ganadoresGR$votos),]
```

Votos ganador
```{r}
primero = ganadoresGR %>% group_by(UBIGEOREGION) %>% filter(row_number()==1) %>% mutate(primeroGR06=votos)

data_finalGR06 = left_join(data_finalGR06, primero[c(1,5)], by="UBIGEOREGION") #join 
```

Votos segundo
```{r}
segundo = ganadoresGR %>% group_by(UBIGEOREGION) %>% filter(row_number()==2) %>% mutate(segundoGR06=votos)

data_finalGR06 = left_join(data_finalGR06, segundo[c(1,5)], by="UBIGEOREGION") #join 
```

Calculo concentración:

```{r}
data_finalGR06 = data_finalGR06 %>% mutate(concentracionGR06 = primeroGR06/validosGR06 + segundoGR06/validosGR06)

data_finalGR06=data_finalGR06[-c(14,15)]
```

###### NEP Y Herfindahl

Calcular proporción de votos validos al cuadrado

Añadir votos validos a la tabla general:

```{r}
ganadoresGR = left_join(ganadoresGR, data_finalGR06[c(1,6)], by="UBIGEOREGION") #join 
```

Calcular proporción de votos validos al cuadrado

```{r}
ganadoresGR$prop_votos2 = (ganadoresGR$votos/ganadoresGR$validosGR06)^2
```


NEP y Herfindahl por distrito:

```{r}
NEP = ganadoresGR %>% group_by(UBIGEOREGION) %>% 
  summarise(HerfindahlGR06 = sum(prop_votos2, na.rm = T),
            NEPGR06 = 1/sum(prop_votos2, na.rm = T))

data_finalGR06 = left_join(data_finalGR06, NEP, by="UBIGEOREGION") #join 
```

listas:

Eliminar partidos que no tuvieron votos: 

```{r}
ganadoresGR=ganadoresGR[!ganadoresGR$votos==0,]
```

```{r}
listasGR06=ganadoresGR %>% group_by(UBIGEOREGION) %>%  summarise(listasGR06=n())

data_finalGR06 = left_join(data_finalGR06, listasGR06, by="UBIGEOREGION") #join 
```

```{r}
head(data_finalGR06)
```

##### GOBIERNO REGIONAL 2010

Carga data: 

```{r}
dataGR02=read_xlsx("Tabla7-ERM2002-Regional.xlsx")
head(dataGR02)
```

Ubigeos

```{r}
#Ubigeo región: 
dataGR02$UBIGEOREGION=dataGR02$UBIGEO
substr(dataGR02$UBIGEOREGION,3,6)='0000'
```

Electores por distritos:

```{r}
electores = dataGR02 %>% 
            group_by(UBIGEO) %>% #seleccionar una fila por distrito
           summarise(electoresGR02 = max(NUMELECTORES, na.rm = T),
                     emitidosGR02 = max(NUM_VOTOS_EMITIDOS, na.rm=T))

electores$UBIGEOREGION=electores$UBIGEO
substr(electores$UBIGEOREGION,3,6)='0000'

data_finalGR02 = electores %>% 
            group_by(UBIGEOREGION) %>% #seleccionar una fila por distrito
           summarise(electoresGR02 = sum(electoresGR02, na.rm = T),
                     emitidosGR02 = sum(emitidosGR02,na.rm=T))
```

Calcular ausentes: 

```{r}
data_finalGR02 = data_finalGR02 %>% 
  mutate(ausentesGR02= electoresGR02 - emitidosGR02, 
         por_ausentesGR02 = (ausentesGR02/electoresGR02)*100)
```

votos validos:

```{r}
validos = dataGR02 %>% 
            group_by(UBIGEOREGION) %>% #seleccionar una fila por distrito
           summarise(validosGR02 = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 

data_finalGR02 = left_join(data_finalGR02, validos, by="UBIGEOREGION") #join

#Ojo, tengo casos con 0 votos validos.. estoy asumiento que esos son blancos y nulos
```

Votos blancos + nulos

```{r}
data_finalGR02 = data_finalGR02 %>% 
  mutate(blancosnulosGR02 = emitidosGR02 - validosGR02, 
         por_blancosnulosGR02 = (blancosnulosGR02/emitidosGR02)*100)
```

votos partidos politicos:

```{r}
partidos_politicos = dataGR02 %>% filter(TIPOORGPOL == "PARTIDO POLITICO") %>%
                group_by(UBIGEOREGION) %>% 
                summarise(partidosGR02 = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 

data_finalGR02 = left_join(data_finalGR02, partidos_politicos, by="UBIGEOREGION") #join
```

votos movimientos regionales:

```{r}
mov_regionales = dataGR02 %>% filter(TIPOORGPOL == "MOVIMIENTO REGIONAL") %>%
                group_by(UBIGEOREGION) %>% 
                summarise(movimientosGR02 = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 

data_finalGR02 = left_join(data_finalGR02, mov_regionales, by="UBIGEOREGION") #join

data_finalGR02$movimientosGR02[is.na(data_finalGR02$movimientosGR02)] = 0
```

porcentaje partidos/movimientos

```{r}
data_finalGR02  = data_finalGR02 %>% 
          mutate (por_partidosGR02 = (partidosGR02/validosGR02)*100,
                  por_movimientosGR02 = (movimientosGR02/validosGR02)*100) 
```

###Ganadores GR

Ordenar tabla en según votos

```{r}
dataGR02<- dataGR02[order(dataGR02$UBIGEO, -dataGR02$NUM_VOTOS_ORGPOL),] 
```

```{r}
ganadoresGR =dataGR02 %>% group_by(UBIGEOREGION,NOM_ORGPOLITICA) %>% summarise(votos = sum(NUM_VOTOS_ORGPOL, na.rm = T))  %>% mutate(ganadorGR02 = NOM_ORGPOLITICA)
validosGR =dataGR02 %>% group_by(UBIGEOREGION) %>% summarise(votos_validos = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 
ganadoresGR02 = left_join(ganadoresGR, validosGR, by="UBIGEOREGION") #join
ganadoresGR02 = ganadoresGR02  %>% mutate(por_voto = (votos/votos_validos)*100)
ganadoresGR02 = ganadoresGR02[order(ganadoresGR02$UBIGEOREGION, -ganadoresGR02$por_voto),] 
ganadoresGR02 = ganadoresGR02 %>% filter(row_number()==1) %>% select(UBIGEOREGION,ganadorGR02)
ganadoresGR02 = ganadoresGR02[complete.cases(ganadoresGR02),]
```


```{r}
data_finalGR02 = left_join(data_finalGR02, ganadoresGR02, by="UBIGEOREGION") #join 
```

###Indicadores políticos 

###### Concentración:

Votos ganador

```{r}
ganadoresGR =dataGR02 %>% group_by(UBIGEOREGION,NOM_ORGPOLITICA) %>% summarise(votos = sum(NUM_VOTOS_ORGPOL, na.rm = T))  %>% mutate(ganadorGR02 = NOM_ORGPOLITICA)
```

```{r}
ganadoresGR = ganadoresGR [order(ganadoresGR$UBIGEOREGION, -ganadoresGR$votos),]
```

```{r}
primero = ganadoresGR %>% group_by(UBIGEOREGION) %>% filter(row_number()==1) %>% mutate(primeroGR02=votos)

data_finalGR02 = left_join(data_finalGR02, primero[c(1,5)], by="UBIGEOREGION") #join 
```

Votos segundo
```{r}
segundo = ganadoresGR %>% group_by(UBIGEOREGION) %>% filter(row_number()==2) %>% mutate(segundoGR02=votos)

data_finalGR02 = left_join(data_finalGR02, segundo[c(1,5)], by="UBIGEOREGION") #join 
```

Calculo concentración:

```{r}
data_finalGR02 = data_finalGR02 %>% mutate(concentracionGR02 = primeroGR02/validosGR02 + segundoGR02/validosGR02)

data_finalGR02=data_finalGR02[-c(14,15)]
```

###### NEP Y Herfindahl

Calcular proporción de votos validos al cuadrado

Añadir votos validos a la tabla general:

```{r}
ganadoresGR = left_join(ganadoresGR, data_finalGR02[c(1,6)], by="UBIGEOREGION") #join 
```

Calcular proporción de votos validos al cuadrado

```{r}
ganadoresGR$prop_votos2 = (ganadoresGR$votos/ganadoresGR$validosGR02)^2
```

NEP y Herfindahl por distrito:

```{r}
NEP = ganadoresGR %>% group_by(UBIGEOREGION) %>% 
  summarise(HerfindahlGR02 = sum(prop_votos2, na.rm = T),
            NEPGR02 = 1/sum(prop_votos2, na.rm = T))

data_finalGR02 = left_join(data_finalGR02, NEP, by="UBIGEOREGION") #join 
```

listas:

Eliminar partidos que no tuvieron votos: 

```{r}
ganadoresGR=ganadoresGR[!ganadoresGR$votos==0,]
```

```{r}
listasGR02=ganadoresGR %>% group_by(UBIGEOREGION) %>%  summarise(listasGR02=n())

data_finalGR02 = left_join(data_finalGR02, listasGR02, by="UBIGEOREGION") #join 
```

```{r}
head(data_finalGR02)
```

##MERGE CON DATA TOTAL

```{r}
data_regional = full_join(data_finalGR14, data_finalGR10, by = c("TXUBIGEOREGION" = "UBIGEOREGION")) #join
```

```{r}
data_regional = full_join(data_regional, data_finalGR06, by = c("TXUBIGEOREGION" = "UBIGEOREGION")) #join
```

```{r}
data_regional = full_join(data_regional, data_finalGR02, by = c("TXUBIGEOREGION" = "UBIGEOREGION")) #join
```

```{r}
save(data_regional, file = "data_regional.rda")
```

## Provincias

## 2014

###Carga data: 

```{r}
dataGP14=read_xlsx("PROVINCIAL_2014_DISTRITAL.xlsx")
head(dataGP14)
```

```{r}
#Ubigeo provincia: 
dataGP14$TXUBIGEOPROVINCIA=dataGP14$TXUBIGEO
substr(dataGP14$TXUBIGEOPROVINCIA,5,6)='00'
```

Electores por distritos:

```{r}
electores = dataGP14 %>% 
            group_by(TXUBIGEO) %>% #seleccionar una fila por distrito
           summarise(electoresGP14 = max(ELECTORES, na.rm = T))

electores$TXUBIGEOPROVINCIA=electores$TXUBIGEO
substr(electores$TXUBIGEOPROVINCIA,5,6)='00'

data_finalGP14 = electores %>% 
            group_by(TXUBIGEOPROVINCIA) %>% #seleccionar una fila por distrito
           summarise(electoresGP14 = sum(electoresGP14, na.rm = T))
```

Votos emitidos por distritos:

```{r}
emitidos = dataGP14 %>% group_by(TXUBIGEOPROVINCIA) %>% 
           summarise(emitidosGP14 = sum(VOTOS, na.rm = T))

data_finalGP14 = left_join(data_finalGP14, emitidos, by="TXUBIGEOPROVINCIA") #join
```

Calcular ausentes: 

```{r}
data_finalGP14 = data_finalGP14 %>% 
  mutate(ausentesGP14= electoresGP14 - emitidosGP14, 
         por_ausentesGP14 = (ausentesGP14/electoresGP14)*100)
```

Votos blancos + nulos

```{r}
blancos_nulos = dataGP14 %>% filter(TXORGPOL == "VOTOS EN BLANCO" | TXORGPOL =="VOTOS NULOS" ) %>% group_by(TXUBIGEOPROVINCIA) %>% 
                summarise(blancosnulosGP14 = sum(VOTOS, na.rm = T)) 

data_finalGP14 = left_join(data_finalGP14, blancos_nulos, by="TXUBIGEOPROVINCIA") #join

data_finalGP14  = data_finalGP14 %>% 
          mutate (por_blancosnulosGP14 = (blancosnulosGP14/emitidosGP14)*100) 
```

votos validos:

```{r}
data_finalGP14  = data_finalGP14 %>% 
          mutate (validosGP14 = emitidosGP14-blancosnulosGP14) 
```

votos partidos politicos:

```{r}
partidos_politicos = dataGP14 %>% filter(TIPOORGPOL == "PARTIDO POLITICO") %>%
                group_by(TXUBIGEOPROVINCIA) %>% 
                summarise(partidosGP14 = sum(VOTOS, na.rm = T)) 

data_finalGP14 = left_join(data_finalGP14, partidos_politicos, by="TXUBIGEOPROVINCIA") #join

data_finalGP14$partidosGP14[is.na(data_finalGP14$partidosGP14)] = 0
```

votos movimientos regionales:

```{r}
mov_regionales = dataGP14 %>% filter(TIPOORGPOL == "MOVIMIENTO REGIONAL") %>%
                group_by(TXUBIGEOPROVINCIA) %>% 
                summarise(movimientosGP14 = sum(VOTOS, na.rm = T)) 

data_finalGP14 = left_join(data_finalGP14, mov_regionales, by="TXUBIGEOPROVINCIA") #join

data_finalGP14$movimientosGP14[is.na(data_finalGP14$movimientosGP14)] = 0
```

porcentaje partidos/movimientos

```{r}
data_finalGP14  = data_finalGP14 %>% 
          mutate (por_partidosGP14 = (partidosGP14/validosGP14)*100,
                  por_movimientosGP14 = (movimientosGP14/validosGP14)*100)

data_finalGP14$por_partidosGP14[is.nan(data_finalGP14$por_partidosGP14)] = 0 
data_finalGP14$por_movimientosGP14[is.nan(data_finalGP14$por_movimientosGP14)] = 0 
```

###Ganadores GP

Eliminar votos blancos y nulos:

```{r}
dataGP14= dataGP14[!dataGP14$TXORGPOL == "VOTOS EN BLANCO",]
dataGP14= dataGP14[!dataGP14$TXORGPOL == "VOTOS NULOS",]
```

Ordenar tabla en según votos

```{r}
dataGP14 <- dataGP14[order(dataGP14$TXUBIGEO, -dataGP14$VOTOS),] 
```

```{r}
ganadoresGP =dataGP14 %>% group_by(TXUBIGEOPROVINCIA,TXORGPOL) %>% summarise(votos = sum(VOTOS, na.rm = T))  %>% mutate(ganadorGP14 = TXORGPOL)
validosGP =dataGP14 %>% group_by(TXUBIGEOPROVINCIA) %>% summarise(votos_validos = sum(VOTOS, na.rm = T)) 
ganadoresGP14 = left_join(ganadoresGP, validosGP, by="TXUBIGEOPROVINCIA") #join
ganadoresGP14 = ganadoresGP14  %>% mutate(por_voto = (votos/votos_validos)*100)
ganadoresGP14 = ganadoresGP14[order(ganadoresGP14$TXUBIGEOPROVINCIA, -ganadoresGP14$por_voto),] 
ganadoresGP14 = ganadoresGP14 %>% filter(row_number()==1) %>% select(TXUBIGEOPROVINCIA,ganadorGP14)
ganadoresGP14 = ganadoresGP14[complete.cases(ganadoresGP14),]
```

```{r}
data_finalGP14 = left_join(data_finalGP14, ganadoresGP14, by="TXUBIGEOPROVINCIA") #join 
```

```{r}
data_finalGP14$ganadorGP14=ifelse(data_finalGP14$validosGP14==0,NA,data_finalGP14$ganadorGP14)
```

###Indicadores políticos 

###### Concentración:

- P1: Proporción de votos válidos obtenidos por el partido más votado.
- P2: Proporción de votos válidos obtenidos por el segundo par- tido más votado.

C= P1 + P2

Votos ganador

```{r}
ganadoresGP =dataGP14 %>% group_by(TXUBIGEOPROVINCIA,TXORGPOL) %>% summarise(votos = sum(VOTOS, na.rm = T))  %>% mutate(ganadorGP14 = TXORGPOL)
```

```{r}
ganadoresGP = ganadoresGP[order(ganadoresGP$TXUBIGEOPROVINCIA,-ganadoresGP$votos),]
```

Votos ganador
```{r}
primero = ganadoresGP %>% group_by(TXUBIGEOPROVINCIA) %>% filter(row_number()==1) %>% mutate(primeroGP14=votos)

data_finalGP14 = left_join(data_finalGP14, primero[c(1,5)], by="TXUBIGEOPROVINCIA") #join 
```

Votos segundo
```{r}
segundo = ganadoresGP %>% group_by(TXUBIGEOPROVINCIA) %>% filter(row_number()==2) %>% mutate(segundoGP14=votos)

data_finalGP14 = left_join(data_finalGP14, segundo[c(1,5)], by="TXUBIGEOPROVINCIA") #join 
```

Calculo concentración:

```{r}
data_finalGP14 = data_finalGP14 %>% mutate(concentracionGP14 = primeroGP14/validosGP14 + segundoGP14/validosGP14)

data_finalGP14=data_finalGP14[-c(14,15)]
```

###### NEP Y Herfindahl

Nep:

- P= Proporción de votos válidos obtenidos por las organizacio- nes políticas en cada circunscripción.
                          
NEP = 1/ SUM(p^2)     

Herfindahl: SUM(p^2)   

Añadir votos validos a la tabla general:

```{r}
ganadoresGP = left_join(ganadoresGP, data_finalGP14[c(1,8)], by="TXUBIGEOPROVINCIA") #join 
```

Calcular proporción de votos validos al cuadrado

```{r}
ganadoresGP$prop_votos2 = (ganadoresGP$votos/ganadoresGP$validosGP14)^2
```

NEP y Herfindahl por distrito:

```{r}
NEP = ganadoresGP %>% group_by(TXUBIGEOPROVINCIA) %>% 
  summarise(HerfindahlGP14 = sum(prop_votos2, na.rm = T),
            NEPGP14 = 1/sum(prop_votos2, na.rm = T))

data_finalGP14 = left_join(data_finalGP14, NEP, by="TXUBIGEOPROVINCIA") #join 

#cuidar casos sin votos validos
data_finalGP14$HerfindahlGP14[data_finalGP14$HerfindahlGP14==0] = NA 
data_finalGP14$NEPGP14[is.infinite(data_finalGP14$NEPGP14)] = NA 
```

listas:

Eliminar partidos que no tuvieron votos: 

```{r}
ganadoresGP=ganadoresGP[!ganadoresGP$votos==0,]
```

```{r}
listasGP14=ganadoresGP %>% group_by(TXUBIGEOPROVINCIA) %>%  summarise(listasGP14=n())

data_finalGP14 = left_join(data_finalGP14, listasGP14, by="TXUBIGEOPROVINCIA") #join 
```

```{r}
head(data_finalGP14)
```

Integración:

```{r}
#Ubigeo región: 
data_finalGP14$TXUBIGEOREGION=data_finalGP14$TXUBIGEOPROVINCIA
substr(data_finalGP14$TXUBIGEOREGION,3,6)='0000'

data_finalGP14 = data_finalGP14[c(18,1:17)]
```

## Merge: 

```{r}
data_finalGP14 = left_join(data_finalGP14,data_finalGR14[c(1,13)], by="TXUBIGEOREGION") #join

data_finalGP14$HRegProv14 = ifelse(data_finalGP14$ganadorGR14 == data_finalGP14$ganadorGP14,1,0) ## relacion GR con GP

data_finalGP14=data_finalGP14[-19]
```




##### GOBIERNO PROVINCIAL 2010

Carga data: 

```{r}
dataGP10=read_xlsx("Tabla6-ERM2010-Provincial.xlsx")
head(dataGP10)
```

###Ubigeos

```{r}
#Ubigeo provincia: 
dataGP10$UBIGEOPROVINCIA=dataGP10$UBIGEO
substr(dataGP10$UBIGEOPROVINCIA,5,6)='00'
```

Electores por distritos:

```{r}
electores = dataGP10 %>% 
            group_by(UBIGEO) %>% #seleccionar una fila por distrito
           summarise(electoresGP10 = max(NUMELECTORES, na.rm = T),
                     emitidosGP10= max(NUM_VOTOS_EMITIDOS, na.rm = T))

electores$UBIGEOPROVINCIA=electores$UBIGEO
substr(electores$UBIGEOPROVINCIA,5,6)='00'

data_finalGP10 = electores %>% 
            group_by(UBIGEOPROVINCIA) %>% #seleccionar una fila por distrito
           summarise(electoresGP10 = sum(electoresGP10, na.rm = T),
                     emitidosGP10 = sum(emitidosGP10, na.rm=T))
```

Calcular ausentes: 

```{r}
data_finalGP10 = data_finalGP10 %>% 
  mutate(ausentesGP10= electoresGP10 - emitidosGP10, 
         por_ausentesGP10 = (ausentesGP10/electoresGP10)*100)
```

votos validos:

```{r}
validos = dataGP10 %>% 
            group_by(UBIGEOPROVINCIA) %>% #seleccionar una fila por distrito
           summarise(validosGP10 = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 

data_finalGP10 = left_join(data_finalGP10, validos, by="UBIGEOPROVINCIA") #join

#Ojo, tengo casos con 0 votos validos.. estoy asumiento que esos son blancos y nulos
```

Votos blancos + nulos

```{r}
data_finalGP10 = data_finalGP10 %>% 
  mutate(blancosnulosGP10 = emitidosGP10 - validosGP10, 
         por_blancosnulosGP10 = (blancosnulosGP10/emitidosGP10)*100)
```

votos partidos politicos:

```{r}
partidos_politicos = dataGP10 %>% filter(TIPOORGPOL == "PARTIDO POLITICO") %>%
                group_by(UBIGEOPROVINCIA) %>% 
                summarise(partidosGP10 = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 

data_finalGP10 = left_join(data_finalGP10, partidos_politicos, by="UBIGEOPROVINCIA") #join

data_finalGP10$partidosGP10[is.na(data_finalGP10$partidosGP10)] = 0
```

votos movimientos regionales:

```{r}
mov_regionales = dataGP10 %>% filter(TIPOORGPOL == "MOVIMIENTO REGIONAL") %>%
                group_by(UBIGEOPROVINCIA) %>% 
                summarise(movimientosGP10 = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 

data_finalGP10 = left_join(data_finalGP10, mov_regionales, by="UBIGEOPROVINCIA") #join

data_finalGP10$movimientosGP10[is.na(data_finalGP10$movimientosGP10)] = 0
```

porcentaje partidos/movimientos

```{r}
data_finalGP10  = data_finalGP10 %>% 
          mutate (por_partidosGP10 = (partidosGP10/validosGP10)*100,
                  por_movimientosGP10 = (movimientosGP10/validosGP10)*100) 

data_finalGP10$por_partidosGP10[is.nan(data_finalGP10$por_partidosGP10)] = 0 
data_finalGP10$por_movimientosGP10[is.nan(data_finalGP10$por_movimientosGP10)] = 0 
```

###Ganadores GP

Ordenar tabla en según votos

```{r}
dataGP10<- dataGP10[order(dataGP10$UBIGEO, -dataGP10$NUM_VOTOS_ORGPOL),] 
```

```{r}
ganadoresGP =dataGP10 %>% group_by(UBIGEOPROVINCIA,NOM_ORGPOLITICA) %>% summarise(votos = sum(NUM_VOTOS_ORGPOL, na.rm = T))  %>% mutate(ganadorGP10 = NOM_ORGPOLITICA)
validosGP =dataGP10 %>% group_by(UBIGEOPROVINCIA) %>% summarise(votos_validos = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 
ganadoresGP10 = left_join(ganadoresGP, validosGP, by="UBIGEOPROVINCIA") #join
ganadoresGP10 = ganadoresGP10  %>% mutate(por_voto = (votos/votos_validos)*100)
ganadoresGP10 = ganadoresGP10[order(ganadoresGP10$UBIGEOPROVINCIA, -ganadoresGP10$por_voto),] 
ganadoresGP10 = ganadoresGP10 %>% filter(row_number()==1) %>% select(UBIGEOPROVINCIA,ganadorGP10)
ganadoresGP10 = ganadoresGP10[complete.cases(ganadoresGP10),]
```

```{r}
data_finalGP10 = left_join(data_finalGP10, ganadoresGP10, by="UBIGEOPROVINCIA") #join 
```

###Indicadores políticos 

###### Concentración:

```{r}
ganadoresGP =dataGP10 %>% group_by(UBIGEOPROVINCIA,NOM_ORGPOLITICA) %>% summarise(votos = sum(NUM_VOTOS_ORGPOL, na.rm = T))  %>% mutate(ganadorGP10 = NOM_ORGPOLITICA)
```

```{r}
ganadoresGP = ganadoresGP[order(ganadoresGP$UBIGEOPROVINCIA,-ganadoresGP$votos),]
```

Votos ganador
```{r}
primero = ganadoresGP %>% group_by(UBIGEOPROVINCIA) %>% filter(row_number()==1) %>% mutate(primeroGP10=votos)

data_finalGP10 = left_join(data_finalGP10, primero[c(1,5)], by="UBIGEOPROVINCIA") #join 
```

Votos segundo
```{r}
segundo = ganadoresGP %>% group_by(UBIGEOPROVINCIA) %>% filter(row_number()==2) %>% mutate(segundoGP10=votos)

data_finalGP10 = left_join(data_finalGP10, segundo[c(1,5)], by="UBIGEOPROVINCIA") #join
```

Calculo concentración:

```{r}
data_finalGP10 = data_finalGP10 %>% mutate(concentracionGP10 = primeroGP10/validosGP10 + segundoGP10/validosGP10)

data_finalGP10=data_finalGP10[-c(14,15)]
```

###### NEP Y Herfindahl

NEP y Herfindahl por distrito:

Añadir votos validos a la tabla general:

```{r}
ganadoresGP = left_join(ganadoresGP, data_finalGP10[c(1,6)], by="UBIGEOPROVINCIA") #join 
```

Calcular proporción de votos validos al cuadrado

```{r}
ganadoresGP$prop_votos2 = (ganadoresGP$votos/ganadoresGP$validosGP10)^2
```

```{r}
NEP = ganadoresGP %>% group_by(UBIGEOPROVINCIA) %>% 
  summarise(HerfindahlGP10 = sum(prop_votos2, na.rm = T),
            NEPGP10 = 1/sum(prop_votos2, na.rm = T))

data_finalGP10 = left_join(data_finalGP10, NEP, by="UBIGEOPROVINCIA") #join 
```

listas:

Eliminar partidos que no tuvieron votos: 

```{r}
ganadoresGP=ganadoresGP[!ganadoresGP$votos==0,]
```

```{r}
listasGP10=ganadoresGP %>% group_by(UBIGEOPROVINCIA) %>%  summarise(listasGP10=n())

data_finalGP10 = left_join(data_finalGP10, listasGP10, by="UBIGEOPROVINCIA") #join 
```

```{r}
head(data_finalGP10)
```

Integración:

```{r}
#Ubigeo región: 
data_finalGP10$UBIGEOREGION=data_finalGP10$UBIGEOPROVINCIA
substr(data_finalGP10$UBIGEOREGION,3,6)='0000'

data_finalGP10 = data_finalGP10[c(18,1:17)]
```

## Merge: 

```{r}
data_finalGP10 = left_join(data_finalGP10,data_finalGR10[c(1,13)], by="UBIGEOREGION") #join

data_finalGP10$HRegProv10 = ifelse(data_finalGP10$ganadorGP10 == data_finalGP10$ganadorGR10,1,0) ## relacion GR con GP

data_finalGP10=data_finalGP10[-19]
```

##### GOBIERNO PROVINCIAL 2006

Carga data: 

```{r}
dataGP06=read_xlsx("Tabla5-ERM2006-Provincial.xlsx")
head(dataGP06)
```

Ubigeos

```{r}
#Ubigeo provincia: 
dataGP06$UBIGEOPROVINCIA=dataGP06$UBIGEO
substr(dataGP06$UBIGEOPROVINCIA,5,6)='00'
```

```{r}
electores = dataGP06 %>% 
            group_by(UBIGEO) %>% #seleccionar una fila por distrito
           summarise(electoresGP06 = max(NUMELECTORES, na.rm = T),
                     emitidosGP06= max(NUM_VOTOS_EMITIDOS, na.rm = T))

electores$UBIGEOPROVINCIA=electores$UBIGEO
substr(electores$UBIGEOPROVINCIA,5,6)='00'

data_finalGP06 = electores %>% 
            group_by(UBIGEOPROVINCIA) %>% #seleccionar una fila por distrito
           summarise(electoresGP06 = sum(electoresGP06, na.rm = T),
                     emitidosGP06 = sum(emitidosGP06, na.rm=T))
```

Calcular ausentes: 

```{r}
data_finalGP06 = data_finalGP06 %>% 
  mutate(ausentesGP06= electoresGP06 - emitidosGP06, 
         por_ausentesGP06 = (ausentesGP06/electoresGP06)*100)
```

votos validos:

```{r}
validos = dataGP06 %>% 
            group_by(UBIGEOPROVINCIA) %>% #seleccionar una fila por distrito
           summarise(validosGP06= sum(NUM_VOTOS_ORGPOL, na.rm = T)) 

data_finalGP06 = left_join(data_finalGP06, validos, by="UBIGEOPROVINCIA") #join

#Ojo, tengo casos con 0 votos validos.. estoy asumiento que esos son blancos y nulos
```

Votos blancos + nulos

```{r}
data_finalGP06 = data_finalGP06 %>% 
  mutate(blancosnulosGP06 = emitidosGP06 - validosGP06, 
         por_blancosnulosGP06 = (blancosnulosGP06/emitidosGP06)*100)
```

votos partidos politicos:

```{r}
partidos_politicos = dataGP06 %>% filter(TIPOORGPOL == "PARTIDO POLITICO") %>%
                group_by(UBIGEOPROVINCIA) %>% 
                summarise(partidosGP06 = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 

data_finalGP06 = left_join(data_finalGP06, partidos_politicos, by="UBIGEOPROVINCIA") #join

data_finalGP06$partidosGP06[is.na(data_finalGP06$partidosGP06)] = 0
```

votos movimientos regionales:

```{r}
mov_regionales = dataGP06 %>% filter(TIPOORGPOL == "MOVIMIENTO REGIONAL") %>%
                group_by(UBIGEOPROVINCIA) %>% 
                summarise(movimientosGP06 = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 

data_finalGP06 = left_join(data_finalGP06, mov_regionales, by="UBIGEOPROVINCIA") #join

data_finalGP06$movimientosGP06[is.na(data_finalGP06$movimientosGP06)] = 0
```

porcentaje partidos/movimientos

```{r}
data_finalGP06  = data_finalGP06 %>% 
          mutate (por_partidosGP06 = (partidosGP06/validosGP06)*100,
                  por_movimientosGP06 = (movimientosGP06/validosGP06)*100) 

data_finalGP06$por_partidosGP06[is.nan(data_finalGP06$por_partidosGP06)] = 0 
data_finalGP06$por_movimientosGP06[is.nan(data_finalGP06$por_movimientosGP06)] = 0 
```

###Ganadores GP

Eliminar:

```{r}
dataGP06= dataGP06[!dataGP06$TIPOORGPOL == "VOTOS EN BLANCO",]
dataGP06= dataGP06[!dataGP06$TIPOORGPOL == "VOTOS NULOS",]
```

Ordenar tabla en según votos

```{r}
dataGP06<- dataGP06[order(dataGP06$UBIGEO, -dataGP06$NUM_VOTOS_ORGPOL),] 
```

```{r}
ganadoresGP =dataGP06 %>% group_by(UBIGEOPROVINCIA,NOM_ORGPOLITICA) %>% summarise(votos = sum(NUM_VOTOS_ORGPOL, na.rm = T))  %>% mutate(ganadorGP06 = NOM_ORGPOLITICA)
validosGP =dataGP06 %>% group_by(UBIGEOPROVINCIA) %>% summarise(votos_validos = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 
ganadoresGP06 = left_join(ganadoresGP, validosGP, by="UBIGEOPROVINCIA") #join
ganadoresGP06 = ganadoresGP06  %>% mutate(por_voto = (votos/votos_validos)*100)
ganadoresGP06 = ganadoresGP06[order(ganadoresGP06$UBIGEOPROVINCIA, -ganadoresGP06$por_voto),] 
ganadoresGP06 = ganadoresGP06 %>% filter(row_number()==1) %>% select(UBIGEOPROVINCIA,ganadorGP06)
ganadoresGP06 = ganadoresGP06[complete.cases(ganadoresGP06),]
```

```{r}
data_finalGP06 = left_join(data_finalGP06, ganadoresGP06, by="UBIGEOPROVINCIA") #join 
```

###Indicadores políticos 

###### Concentración:

```{r}
ganadoresGP =dataGP06 %>% group_by(UBIGEOPROVINCIA,NOM_ORGPOLITICA) %>% summarise(votos = sum(NUM_VOTOS_ORGPOL, na.rm = T))  %>% mutate(ganadorGP06 = NOM_ORGPOLITICA)
```

```{r}
ganadoresGP = ganadoresGP[order(ganadoresGP$UBIGEOPROVINCIA,-ganadoresGP$votos),]
```

Votos ganador
```{r}
primero = ganadoresGP %>% group_by(UBIGEOPROVINCIA) %>% filter(row_number()==1) %>% mutate(primeroGP06=votos)

data_finalGP06 = left_join(data_finalGP06, primero[c(1,5)], by="UBIGEOPROVINCIA") #join 
```

Votos segundo
```{r}
segundo = ganadoresGP %>% group_by(UBIGEOPROVINCIA) %>% filter(row_number()==2) %>% mutate(segundoGP06=votos)

data_finalGP06 = left_join(data_finalGP06, segundo[c(1,5)], by="UBIGEOPROVINCIA") #join 
```

Calculo concentración:

```{r}
data_finalGP06 = data_finalGP06 %>% mutate(concentracionGP06 = primeroGP06/validosGP06 + segundoGP06/validosGP06)

data_finalGP06=data_finalGP06[-c(14,15)]
```

###### NEP Y Herfindahl

Añadir votos validos a la tabla general:

```{r}
ganadoresGP = left_join(ganadoresGP, data_finalGP06[c(1,6)], by="UBIGEOPROVINCIA") #join 
```

Calcular proporción de votos validos al cuadrado

```{r}
ganadoresGP$prop_votos2 = (ganadoresGP$votos/ganadoresGP$validosGP06)^2
```

NEP y Herfindahl por distrito:

```{r}
NEP = ganadoresGP %>% group_by(UBIGEOPROVINCIA) %>% 
  summarise(HerfindahlGP06 = sum(prop_votos2, na.rm = T),
            NEPGP06 = 1/sum(prop_votos2, na.rm = T))

data_finalGP06 = left_join(data_finalGP06, NEP, by="UBIGEOPROVINCIA") #join 
```


listas:

Eliminar partidos que no tuvieron votos: 

```{r}
ganadoresGP=ganadoresGP[!ganadoresGP$votos==0,]
```

```{r}
listasGP06=ganadoresGP %>% group_by(UBIGEOPROVINCIA) %>%  summarise(listasGP06=n())

data_finalGP06 = left_join(data_finalGP06, listasGP06, by="UBIGEOPROVINCIA") #join 
```

```{r}
head(data_finalGP06)
```

Integración:

```{r}
#Ubigeo región: 
data_finalGP06$UBIGEOREGION=data_finalGP06$UBIGEOPROVINCIA
substr(data_finalGP06$UBIGEOREGION,3,6)='0000'

data_finalGP06 = data_finalGP06[c(18,1:17)]
```

## Merge: 

```{r}
data_finalGP06 = left_join(data_finalGP06,data_finalGR06[c(1,13)], by="UBIGEOREGION") #join

data_finalGP06$HRegProv06 = ifelse(data_finalGP06$ganadorGP06 == data_finalGP06$ganadorGR06,1,0) ## relacion GR con GP

data_finalGP06=data_finalGP06[-19]
```



##### GOBIERNO PROVINCIAL 2002

Carga data: 

```{r}
dataGP02=read_xlsx("Tabla4-ERM2002-Provincial.xlsx")
head(dataGP02)
```
###ORDENAR DATA:

###Ubigeos

```{r}
#Ubigeo provincia: 
dataGP02$UBIGEOPROVINCIA=dataGP02$UBIGEO
substr(dataGP02$UBIGEOPROVINCIA,5,6)='00'
```

###Ordenar data:

Electores por distritos:

```{r}
electores = dataGP02 %>% 
            group_by(UBIGEO) %>% #seleccionar una fila por distrito
           summarise(electoresGP02 = max(NUMELECTORES, na.rm = T),
                     emitidosGP02= max(NUM_VOTOS_EMITIDOS, na.rm = T))

electores$UBIGEOPROVINCIA=electores$UBIGEO
substr(electores$UBIGEOPROVINCIA,5,6)='00'

data_finalGP02 = electores %>% 
            group_by(UBIGEOPROVINCIA) %>% #seleccionar una fila por distrito
           summarise(electoresGP02 = sum(electoresGP02, na.rm = T),
                     emitidosGP02 = sum(emitidosGP02, na.rm=T))
```


Calcular ausentes: 

```{r}
data_finalGP02 = data_finalGP02 %>% 
  mutate(ausentesGP02 = electoresGP02 - emitidosGP02, 
         por_ausentesGP02 = (ausentesGP02/electoresGP02)*100)
```

votos validos:

```{r}
validos = dataGP02 %>% 
            group_by(UBIGEOPROVINCIA) %>% #seleccionar una fila por distrito
           summarise(validosGP02 = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 

data_finalGP02 = left_join(data_finalGP02, validos, by="UBIGEOPROVINCIA") #join
```

Votos blancos + nulos

```{r}
data_finalGP02 = data_finalGP02 %>% 
  mutate(blancosnulosGP02 = emitidosGP02 - validosGP02, 
         por_blancosnulosGP02 = (blancosnulosGP02/emitidosGP02)*100)
```

votos partidos politicos:

```{r}
partidos_politicos = dataGP02 %>% filter(TIPOORGPOL == "PARTIDO POLITICO") %>%
                group_by(UBIGEOPROVINCIA) %>% 
                summarise(partidosGP02 = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 

data_finalGP02 = left_join(data_finalGP02, partidos_politicos, by="UBIGEOPROVINCIA") #join

data_finalGP02$partidosGP02[is.na(data_finalGP02$partidosGP02)] = 0
```

votos movimientos regionales:

```{r}
mov_regionales = dataGP02 %>% filter(TIPOORGPOL == "MOVIMIENTO REGIONAL") %>%
                group_by(UBIGEOPROVINCIA) %>% 
                summarise(movimientosGP02 = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 

data_finalGP02 = left_join(data_finalGP02, mov_regionales, by="UBIGEOPROVINCIA") #join

data_finalGP02$movimientosGP02[is.na(data_finalGP02$movimientosGP02)] = 0
```

porcentaje partidos/movimientos

```{r}
data_finalGP02  = data_finalGP02 %>% 
          mutate (por_partidosGP02 = (partidosGP02/validosGP02)*100,
                  por_movimientosGP02 = (movimientosGP02/validosGP02)*100) 

data_finalGP02$por_partidosGP02[is.nan(data_finalGP02$por_partidosGP02)] = 0 
data_finalGP02$por_movimientosGP02[is.nan(data_finalGP02$por_movimientosGP02)] = 0 
```

###Ganadores GP

Ordenar tabla en según votos

```{r}
dataGP02<- dataGP02[order(dataGP02$UBIGEO, -dataGP02$NUM_VOTOS_ORGPOL),] 
```

```{r}
ganadoresGP =dataGP02 %>% group_by(UBIGEOPROVINCIA,NOM_ORGPOLITICA) %>% summarise(votos = sum(NUM_VOTOS_ORGPOL, na.rm = T))  %>% mutate(ganadorGP02 = NOM_ORGPOLITICA)
validosGP =dataGP02 %>% group_by(UBIGEOPROVINCIA) %>% summarise(votos_validos = sum(NUM_VOTOS_ORGPOL, na.rm = T)) 
ganadoresGP02 = left_join(ganadoresGP, validosGP, by="UBIGEOPROVINCIA") #join
ganadoresGP02 = ganadoresGP02  %>% mutate(por_voto = (votos/votos_validos)*100)
ganadoresGP02 = ganadoresGP02[order(ganadoresGP02$UBIGEOPROVINCIA, -ganadoresGP02$por_voto),] 
ganadoresGP02 = ganadoresGP02 %>% filter(row_number()==1) %>% select(UBIGEOPROVINCIA,ganadorGP02)
ganadoresGP02 = ganadoresGP02[complete.cases(ganadoresGP02),]
```

```{r}
data_finalGP02 = left_join(data_finalGP02, ganadoresGP02, by="UBIGEOPROVINCIA") #join 
```

###Indicadores políticos 

###### Concentración:

```{r}
ganadoresGP =dataGP02 %>% group_by(UBIGEOPROVINCIA,NOM_ORGPOLITICA) %>% summarise(votos = sum(NUM_VOTOS_ORGPOL, na.rm = T))  %>% mutate(ganadorGP02 = NOM_ORGPOLITICA)
```

```{r}
ganadoresGP = ganadoresGP[order(ganadoresGP$UBIGEOPROVINCIA,-ganadoresGP$votos),]
```

Votos ganador
```{r}
primero = ganadoresGP %>% group_by(UBIGEOPROVINCIA) %>% filter(row_number()==1) %>% mutate(primeroGP02=votos)

data_finalGP02 = left_join(data_finalGP02, primero[c(1,5)], by="UBIGEOPROVINCIA") #join 
```

Votos segundo
```{r}
segundo = ganadoresGP %>% group_by(UBIGEOPROVINCIA) %>% filter(row_number()==2) %>% mutate(segundoGP02=votos)

data_finalGP02 = left_join(data_finalGP02, segundo[c(1,5)], by="UBIGEOPROVINCIA") #join 
```

Calculo concentración:

```{r}
data_finalGP02 = data_finalGP02 %>% mutate(concentracionGP02 = primeroGP02/validosGP02 + segundoGP02/validosGP02)

data_finalGP02=data_finalGP02[-c(14,15)]
```

###### NEP Y Herfindahl

Añadir votos validos a la tabla general:

```{r}
ganadoresGP = left_join(ganadoresGP, data_finalGP02[c(1,6)], by="UBIGEOPROVINCIA") #join 
```

Calcular proporción de votos validos al cuadrado

```{r}
ganadoresGP$prop_votos2 = (ganadoresGP$votos/ganadoresGP$validosGP02)^2
```

NEP y Herfindahl por distrito:

```{r}
NEP = ganadoresGP %>% group_by(UBIGEOPROVINCIA) %>% 
  summarise(HerfindahlGP02 = sum(prop_votos2, na.rm = T),
            NEPGP02 = 1/sum(prop_votos2, na.rm = T))

data_finalGP02 = left_join(data_finalGP02, NEP, by="UBIGEOPROVINCIA") #join 
```


listas:

Eliminar partidos que no tuvieron votos: 

```{r}
ganadoresGP=ganadoresGP[!ganadoresGP$votos==0,]
```

```{r}
listasGP02=ganadoresGP %>% group_by(UBIGEOPROVINCIA) %>%  summarise(listasGP02=n())

data_finalGP02 = left_join(data_finalGP02, listasGP02, by="UBIGEOPROVINCIA") #join 
```

```{r}
head(data_finalGP02)
```

Integración:

```{r}
#Ubigeo región: 
data_finalGP02$UBIGEOREGION=data_finalGP02$UBIGEOPROVINCIA
substr(data_finalGP02$UBIGEOREGION,3,6)='0000'

data_finalGP02 = data_finalGP02[c(18,1:17)]
```

## Merge: 

```{r}
data_finalGP02 = left_join(data_finalGP02,data_finalGR02[c(1,13)], by="UBIGEOREGION") #join

data_finalGP02$HRegProv02 = ifelse(data_finalGP02$ganadorGP02 == data_finalGP02$ganadorGR02,1,0) ## relacion GR con GP

data_finalGP02=data_finalGP02[-19]
```


##MERGE CON DATA TOTAL

```{r}
data_provincial = full_join(data_finalGP14, data_finalGP10, by = c("TXUBIGEOPROVINCIA" = "UBIGEOPROVINCIA")) #join
```

```{r}
data_provincial = full_join(data_provincial, data_finalGP06, by = c("TXUBIGEOPROVINCIA" = "UBIGEOPROVINCIA")) #join
```

```{r}
data_provincial = full_join(data_provincial, data_finalGP02, by = c("TXUBIGEOPROVINCIA" = "UBIGEOPROVINCIA")) #join
```

```{r}
save(data_provincial, file = "data_provincial.rda")
```

###Data distrital

```{r}
load("data_final.Rda")
```

```{r}
names(data_final)
```

```{r}
data_distrital=data_final[c(1:3,36:51,53,54,87,102,104,105,138:152,154,155,189,203,205,206)]
```

```{r}
save(data_distrital, file = "data_distrital.rda")
```

